{% extends 'base.html' %}
{% load static %}
{% load thumbnail %}
{% load convert_date %}
<!DOCTYPE html>
<html>

<head>
</head>
{% block content %}
<body>
<!-- **************** MAIN CONTENT START **************** -->
<main>
    <!-- Container START -->
    <div class="container">
        <div class="row gx-0">
        
            <!-- Chat conversation START -->
            <div class="col-lg-8 col-xxl-9">
                <div class="card card-chat rounded-start-lg-0 border-start-lg-0">
                    <div class="card-body h-100">
                        <div class="tab-content py-0 mb-0 h-100" id="chatTabsContent">
                            <!-- Conversation item START -->
                            <div class="fade tab-pane show active h-100" id="chat-1" role="tabpanel" aria-labelledby="chat-1-tab">
                                <!-- Top avatar and status START -->
                                <div class="d-sm-flex justify-content-between align-items-center">
                                    <div class="d-flex mb-2 mb-sm-0">
                                        <div class="flex-shrink-0 avatar me-2">
                                            <img class="avatar-img rounded-circle" src="{% if user.profile.photo %}{% thumbnail user.profile.photo 180x180 %}{% else %}../static/profile.gif{% endif %}" alt="">
                                        </div>
                                        <div class="d-block flex-grow-1">
                                            <h6 class="mb-0 mt-1">{{opposite_user.username | title}}</h6>
                                            <div class="small text-secondary"><i class="fa-solid fa-circle text-success me-1"></i>Online</div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <!-- Call button -->
                                        <a href="#!" class="icon-md rounded-circle btn btn-primary-soft me-2 px-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Audio call"><i class="bi bi-telephone-fill"></i></a>
                                        <a href="#!" class="icon-md rounded-circle btn btn-primary-soft me-2 px-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Video call"><i class="bi bi-camera-video-fill"></i></a>
                                        <!-- Card action START -->
                                        <div class="dropdown">
                                            <a class="icon-md rounded-circle btn btn-primary-soft me-2 px-2" href="#" id="chatcoversationDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></a>               
                                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatcoversationDropdown">
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-check-lg me-2 fw-icon"></i>Mark as read</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-mic-mute me-2 fw-icon"></i>Mute conversation</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-person-check me-2 fw-icon"></i>View profile</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-trash me-2 fw-icon"></i>Delete chat</a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-archive me-2 fw-icon"></i>Archive chat</a></li>
                                            </ul>
                                        </div>
                                        <!-- Card action END -->
                                    </div>
                                </div>

                                
                                <div id="chat-log" class="scroll chat-conversation-content custom-scrollbar">
                                    {% for msg in fetch_all_message %}
                                    <div class="chat_box d-flex mb-1" id="{{msg.id}}">
                                        <div class="flex-shrink-0 avatar avatar-xs me-2">
                                            <img class="avatar-img rounded-circle" src="{% if user.profile.photo %}{% thumbnail user.profile.photo 180x180 %}{% else %}../static/profile.gif{% endif %}" alt="">
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="w-100">
                                                <h5>{{msg.user.username}}</h5>
                                                <div class="bg-light text-secondary p-2 px-3 rounded-2 w-100">{{msg.message_detail.msg}}</div>
                                                <div class="small my-2">{{msg.message_detail.timestamp | convert_date | date:"M d'Y f"}}</div>
                                                {% if msg.user == request.user  %}
                                                    <small id = "as_read" style="padding-left: 95%;{% if msg.message_detail.read %}color: rgb(8, 255, 8);{% else %}color: #bbb8b8 {% endif %}font-weight: bold;">✔✔</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="card-footer">
                                    <div class="d-sm-flex align-items-end">
                                        <textarea id="chat-message-input" class="form-control mb-sm-0 mb-3" data-autoresize placeholder="Type a message" rows="1"></textarea>
                                        <button class="btn btn-sm btn-danger-soft ms-sm-2"><i class="fa-solid fa-face-smile fs-6"></i></button>
                                        <button class="btn btn-sm btn-secondary-soft ms-2"><i class="fa-solid fa-paperclip fs-6"></i></button>
                                        <button id="chat-message-submit" class="btn btn-sm btn-primary ms-2"><i class="fa-solid fa-paper-plane fs-6"></i></button>
                                    </div>
                                </div>
                                {{ room_name|json_script:"room_name" }}
                            </div>
                        </div>
                        <!-- Chat conversation END -->
                    </div> <!-- Row END -->
                    <!-- ======================= Chat END -->
  
                </div>
                <!-- Container END -->
            </div>
        </div>
    </div>
  
</main>
<!-- **************** MAIN CONTENT END **************** -->

  <script>
    const roomName = JSON.parse(document.getElementById('room_name').textContent);

    const chatSocket = new WebSocket(
        'ws://'+ window.location.host+ '/ws/chat/'+ roomName+ '/'
    );

    var send_all_read = () => {setTimeout(() => {
        chatSocket.send(JSON.stringify({
            'msg_type': 'ALL_MESSAGE_READ',
            'user': '{{request.user.username}}'
        }));
        document.querySelector('title').textContent = "Chat Room"
    }, 1000)}

    WebSocket.onopen = send_all_read()

    var messageBody = document.querySelector('.scroll');
    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;

    const add_element = (data,box_color) => {        
        const user = data.user === '{{request.user.username}}' ? "You" : data.user
        const error_msg = data.error_message === 'MESSAGE_OUT_OF_LENGTH' ? "<br/>" + "Error:Msg size must be less then 10 char." + "<br/>" + " • This Message not sent.." :false
        const add_read = data.user === '{{request.user.username}}' ? '<small id="as_read" style="padding-left: 95%; color: #bbb8b8; font-weight: bold;">✔✔</small>':''
        ele = `
            <div id=${data.msg_id} class="chat_box scroll chat-conversation-content custom-scrollbar">
                <div class="d-flex mb-1">
                    <div class="flex-shrink-0 avatar avatar-xs me-2">
                        <img class="avatar-img rounded-circle" src="{% if user.profile.photo %}{% thumbnail user.profile.photo 180x180 %}{% else %}../static/profile.gif{% endif %}" alt="">
                    </div>
                    <div class="flex-grow-1">
                        <div class="w-100">
                            <h5>${user}</h5>
                            <div class="bg-light text-secondary p-2 px-3 rounded-2 w-100">${data.message}<small><br/>${error_msg ? error_msg :add_read }</small></div>
                            <div class="small my-2">${data.timestampe}</div>
                        </div>
                    </div>
                </div>
            </div>
            `
        document.querySelector('#chat-log').innerHTML += ele
        messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
    }

    const check_read = (user_name,msg_id) => {
            if(document.hidden){
                let unread_msg = document.querySelector('title').textContent.split(":")[1];
                if(unread_msg){
                    document.querySelector('title').textContent = "Unread Messages : " + (parseInt(unread_msg) + 1)
                }
                else{
                    document.querySelector('title').textContent = "Unread Messages : " + 1
                }
            }
            else{
                if (user_name !== '{{request.user.username}}') {
                    chatSocket.send(JSON.stringify({
                        'msg_type': 'MESSAGE_READ',
                        'msg_id': msg_id,
                        'user': user_name
                    }));
            }
        }
    }

    document.addEventListener("visibilitychange", event => {
        if (document.visibilityState == "visible") {
            let unread_msg = document.querySelector('title').textContent.split(":")[1];
            if (unread_msg) {
                send_all_read()
            }
        }
    })

    chatSocket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if(data.msg_type === 'ERROR_OCCURED'){
            if(data.error_message === 'MESSAGE_OUT_OF_LENGTH'){
                box_color = 'red'
                add_element(data,box_color)
            }
            else if(data.error_message === 'UN_AUTHENTICATED'){
               alert("You are not authenticated user!!!Login Again..")
            }
        }
        else if(data.msg_type === 'TEXT_MESSAGE'){
            box_color = '#7d7dee'
            add_element(data,box_color)
            check_read(data.user,data.msg_id)
        }
        else if(data.msg_type === 'MESSAGE_READ'){
            if(data.user === '{{request.user.username}}'){
                setTimeout(() => { document.getElementById(data.msg_id).querySelector('#as_read').style.color = 'rgb(8, 255, 8)'}, 300);
            }
        }
        else if(data.msg_type === 'IS_TYPING'){
            if(data.user !== '{{request.user.username}}'){
                document.getElementById('chat-log').innerHTML += "<span id = 'isTyping'>Typing....</span>"
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }
        }
        else if(data.msg_type === 'NOT_TYPING'){
            if(data.user !== '{{request.user.username}}'){
                document.getElementById('chat-log').removeChild(document.getElementById("isTyping")) 
            }
        }
        else if (data.msg_type === 'ALL_MESSAGE_READ') {
            if (data.user !== '{{request.user.username}}') {
                let check_all_read = document.querySelectorAll('#as_read')
                for (let i = 0; i < check_all_read.length; i++) {
                    if (check_all_read[i].style.color !== 'rgb(8, 255, 8)') {
                        check_all_read[i].style.color = 'rgb(8, 255, 8)'
                    }
                }
            }
        }

    };

    document.querySelector('#chat-message-input').onkeyup = (e) => {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    var isTyping = false;
    var isNotTyping;
    document.getElementById('chat-message-input').onkeypress = () => {
        sendIsTypingToUser()
        if (isNotTyping != undefined) clearTimeout(isNotTyping);
        isNotTyping = setTimeout(sendIsNotTyping, 700);
    };
    function sendIsTypingToUser() {
        if(!isTyping){
            chatSocket.send(JSON.stringify({
                'user': '{{request.user.username}}',
                'msg_type': 'IS_TYPING',
            }));
            isTyping = true
        }
    }
    function sendIsNotTyping() {
        chatSocket.send(JSON.stringify({
            'user': '{{request.user.username}}',
            'msg_type': 'NOT_TYPING',
        }));
        isTyping = false
    }

    document.querySelector('#chat-message-submit').onclick = (e) => {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'message': message,
            'msg_type' : 'TEXT_MESSAGE',
            'user' : '{{request.user.username}}'
        }));

        messageInputDom.value = '';
    };

    const check_user = document.querySelectorAll(".check_user")
    for (let i = 0; i < check_user.length; i++){
        if (check_user[i].innerText === '{{request.user.username}}') {
            check_user[i].innerText = 'You'
        }
    }
</script>

</body>
{% endblock %}
</html>
